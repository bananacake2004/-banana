<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<style>
  /* åŸºæœ¬è¨­å®š (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹) */
  :root {
    --bg-color: #000000;
    --card-bg: #161e27;
    --text-main: #ffffff;
    --text-sub: #aebbc9;
    --accent: #0085ff;
    --border: #2e4052;
    --hover-bg: #1c2633;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    background-color: var(--bg-color);
    color: var(--text-main);
    overflow-y: auto;
  }

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®æ  */
  .profile-card {
    background-color: var(--bg-color);
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
    position: relative;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ */
  .banner {
    width: 100%;
    height: 150px;
    background-color: #333;
    background-size: cover;
    background-position: center;
  }

  /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¨ãƒªã‚¢ */
  .profile-header {
    padding: 0 16px;
    position: relative;
    display: flex;
    justify-content: flex-end; /* ãƒœã‚¿ãƒ³ã‚’å³å¯„ã› */
    align-items: flex-start;
    margin-top: -40px; /* ãƒãƒŠãƒ¼ã«é‡ã­ã‚‹ */
    margin-bottom: 10px;
  }

  /* ã‚¢ã‚¤ã‚³ãƒ³ */
  .avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid var(--bg-color);
    position: absolute;
    left: 16px;
    top: 0;
    background-color: #000;
    object-fit: cover;
  }

  /* ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ (Blueskyé¢¨) */
  .follow-btn {
    margin-top: 50px; /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ã®ä½ç½®èª¿æ•´ */
    background-color: var(--accent);
    color: white;
    border: none;
    padding: 8px 24px;
    border-radius: 999px;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    font-size: 14px;
    transition: opacity 0.2s;
  }
  .follow-btn:hover { opacity: 0.9; }

  /* åå‰ã¨ID */
  .profile-info {
    padding: 0 16px;
    margin-top: 5px;
  }
  .display-name {
    font-size: 24px;
    font-weight: bold;
    margin: 0;
    line-height: 1.2;
  }
  .handle {
    color: var(--text-sub);
    font-size: 15px;
    margin: 4px 0 0 0;
  }

  /* æŠ•ç¨¿ã‚¨ãƒªã‚¢ */
  .feed {
    margin-top: 10px;
  }

  .post {
    padding: 16px;
    border-top: 1px solid var(--border);
    cursor: default;
  }
  
  .post-header {
    display: flex;
    margin-bottom: 5px;
    color: var(--text-sub);
    font-size: 14px;
  }
  
  .post-content {
    font-size: 15px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* å¼•ç”¨ï¼ˆç°è‰²ã®æ ï¼‰ */
  .quote-box {
    margin-top: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ */
    transition: background-color 0.2s;
  }
  .quote-box:hover {
    background-color: rgba(255,255,255,0.05);
  }

  .quote-author {
    font-weight: bold;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .quote-author img {
    width: 20px;
    height: 20px;
    border-radius: 50%;
  }
  .quote-handle {
    color: var(--text-sub);
    font-weight: normal;
  }

  /* ãƒ”ãƒ³ç•™ã‚ãƒ©ãƒ™ãƒ« */
  .pinned-label {
    color: var(--text-sub);
    font-size: 13px;
    font-weight: bold;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* ãƒªãƒ³ã‚¯ã®è‰² */
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }

</style>
</head>
<body>

<div class="profile-card">
  <div id="banner" class="banner"></div>
  <div class="profile-header">
    <img id="avatar" class="avatar" src="" alt="">
    <a id="follow-link" href="#" target="_blank" class="follow-btn">Follow</a>
  </div>
  <div class="profile-info">
    <h1 id="display-name" class="display-name">Loading...</h1>
    <p id="handle" class="handle">@...</p>
  </div>
</div>

<div id="pinned-container"></div>

<div id="feed" class="feed"></div>

<script>
  // â˜…ã“ã“ã«ã‚ãªãŸã®ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã‚’å…¥ã‚Œã¦ãã ã•ã„
  const HANDLE = "katsuobushi-kawa.bsky.social"; 
  const API_BASE = "https://public.api.bsky.app/xrpc";

  // è¦ç´ ã®å–å¾—
  const els = {
    banner: document.getElementById('banner'),
    avatar: document.getElementById('avatar'),
    name: document.getElementById('display-name'),
    handle: document.getElementById('handle'),
    follow: document.getElementById('follow-link'),
    pinned: document.getElementById('pinned-container'),
    feed: document.getElementById('feed')
  };

  async function fetchProfile() {
    try {
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
      const res = await fetch(`${API_BASE}/app.bsky.actor.getProfile?actor=${HANDLE}`);
      const data = await res.json();

      // UIåæ˜ 
      if (data.banner) els.banner.style.backgroundImage = `url(${data.banner})`;
      els.avatar.src = data.avatar || '';
      els.name.textContent = data.displayName || data.handle;
      els.handle.textContent = `@${data.handle}`;
      els.follow.href = `https://bsky.app/profile/${data.handle}`;

      // ãƒ”ãƒ³ç•™ã‚ãŒã‚ã‚‹ã‹ç¢ºèª
      if (data.pinnedPost) {
        fetchPinnedPost(data.pinnedPost.uri);
      } else {
         // ãƒ”ãƒ³ç•™ã‚ãŒãªã„å ´åˆã€é€šå¸¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
         fetchAuthorFeed();
      }

    } catch (e) {
      console.error(e);
      els.name.textContent = "Error loading profile";
    }
  }

  // ãƒ”ãƒ³ç•™ã‚æŠ•ç¨¿ã®å–å¾—
  async function fetchPinnedPost(uri) {
    // at://did:plc:.../app.bsky.feed.post/12345 å½¢å¼ã‚’åˆ†è§£
    const parts = uri.split('/');
    const repo = parts[2]; // did
    const rkey = parts[4]; // postID

    try {
      const res = await fetch(`${API_BASE}/app.bsky.feed.getPostThread?uri=${uri}&depth=0`);
      const data = await res.json();
      
      if(data.thread) {
        const postElement = createPostElement(data.thread.post, true); // true = pinned
        els.pinned.appendChild(postElement);
      }
      
      // ãƒ”ãƒ³ç•™ã‚ã®å¾Œã«é€šå¸¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚‚èª­ã¿è¾¼ã‚€
      fetchAuthorFeed(uri); // ãƒ”ãƒ³ç•™ã‚ã¨åŒã˜æŠ•ç¨¿ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã«URIã‚’æ¸¡ã™
    } catch(e) {
      console.error("Pinned post error", e);
      fetchAuthorFeed();
    }
  }

  // é€šå¸¸ãƒ•ã‚£ãƒ¼ãƒ‰ã®å–å¾—
  async function fetchAuthorFeed(pinnedUri = null) {
    try {
      const res = await fetch(`${API_BASE}/app.bsky.feed.getAuthorFeed?actor=${HANDLE}&limit=5&filter=posts_no_replies`);
      const data = await res.json();

      data.feed.forEach(item => {
        // ãƒ”ãƒ³ç•™ã‚ã¨åŒã˜æŠ•ç¨¿ã¯è¡¨ç¤ºã—ãªã„
        if (pinnedUri && item.post.uri === pinnedUri) return;
        
        const postElement = createPostElement(item.post, false);
        els.feed.appendChild(postElement);
      });
    } catch (e) {
      console.error(e);
    }
  }

  // æŠ•ç¨¿HTMLã®ä½œæˆ
  function createPostElement(post, isPinned) {
    const record = post.record;
    const author = post.author;
    
    // æŠ•ç¨¿ã®ãƒªãƒ³ã‚¯ä½œæˆ (webã‚¢ãƒ—ãƒªã¸ã®ãƒªãƒ³ã‚¯)
    const postParts = post.uri.split('/');
    const postId = postParts[postParts.length - 1];
    const postUrl = `https://bsky.app/profile/${author.handle}/post/${postId}`;

    const div = document.createElement('div');
    div.className = 'post';

    // ãƒ”ãƒ³ç•™ã‚ãƒ©ãƒ™ãƒ«
    let pinHtml = '';
    if (isPinned) {
      pinHtml = `<div class="pinned-label">ğŸ“Œ Pinned Post</div>`;
    }

    // å¼•ç”¨ï¼ˆEmbed Recordï¼‰ã®å‡¦ç†
    let quoteHtml = '';
    if (post.embed && post.embed.$type === 'app.bsky.embed.record#view') {
      const quote = post.embed.record;
      // å¼•ç”¨å…ƒã®URLç”Ÿæˆ
      const qParts = quote.uri.split('/');
      const qId = qParts[qParts.length - 1];
      const qHandle = quote.author.handle; // APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã«ã‚ˆã‚‹
      const qUrl = `https://bsky.app/profile/${qHandle}/post/${qId}`;

      // å¼•ç”¨ãƒœãƒƒã‚¯ã‚¹ (ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š)
      // data-hrefå±æ€§ã«URLã‚’æŒãŸã›ã€JSã§é·ç§»ã•ã›ã‚‹
      quoteHtml = `
        <div class="quote-box" onclick="window.open('${qUrl}', '_blank')">
          <div class="quote-author">
            <img src="${quote.author.avatar}" alt="">
            <span>${quote.author.displayName || quote.author.handle}</span>
            <span class="quote-handle">@${quote.author.handle}</span>
          </div>
          <div class="post-content" style="margin-top:5px;">
            ${quote.value.text || ''}
          </div>
        </div>
      `;
    }

    // HTMLæ§‹ç¯‰
    div.innerHTML = `
      ${pinHtml}
      <div class="post-header">
        <strong>${author.displayName || author.handle}</strong>
        <span style="margin-left:5px; color:#666;">@${author.handle}</span>
      </div>
      <div class="post-content">
        ${record.text}
      </div>
      ${quoteHtml}
      <div style="margin-top:8px;">
        <a href="${postUrl}" target="_blank" style="font-size:12px; color:#666;">View on Bluesky</a>
      </div>
    `;

    return div;
  }

  // å®Ÿè¡Œ
  fetchProfile();
</script>

</body>
</html>
