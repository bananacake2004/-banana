<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Bluesky Feed (ver33.0)</title>
<style>
    /* --------------------------------------------------
       åŸºæœ¬è¨­å®š
       -------------------------------------------------- */
    body, html {
        margin: 0; padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: #0f1419; line-height: 1.6;
        background-color: #f9f9f9; scroll-behavior: smooth;
    }

    .container {
        max-width: 600px; margin: 0 auto; padding: 20px;
    }

    /* ã‚«ãƒ¼ãƒ‰æœ¬ä½“ */
    .card {
        background: #fff; border: 1px solid #cfd9de; border-radius: 16px;
        padding: 16px; margin-bottom: 24px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        transition: background-color 1s ease;
    }
    .card.highlight { background-color: #fff8c5; transition: none; }

    /* è¦ªæŠ•ç¨¿ï¼ˆè‡ªåˆ†ã¸ã®è¿”ä¿¡ï¼‰ã®ã‚°ãƒ¬ãƒ¼æ  */
    .parent-post-preview {
        display: block; text-decoration: none;
        background-color: #f7f9f9; border: 1px solid #eff3f4;
        border-radius: 12px; padding: 12px; margin-bottom: 12px;
        font-size: 0.9rem; color: #536471; cursor: pointer;
    }
    .parent-post-preview:hover { background-color: #eff1f1; }
    .parent-post-preview::before {
        content: "è¿”ä¿¡å…ˆ: è‡ªåˆ† (ç›´å‰ã®æŠ•ç¨¿)"; display: block;
        font-size: 0.75rem; color: #536471; margin-bottom: 4px; font-weight: bold;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .post-header { display: flex; align-items: flex-start; margin-bottom: 8px; }
    .user-avatar { width: 48px; height: 48px; border-radius: 50%; margin-right: 12px; object-fit: cover; background: #eee; flex-shrink: 0; }
    .user-info { flex: 1; line-height: 1.2; padding-top: 4px; }
    .user-name { font-weight: bold; font-size: 1rem; display: block; color: #0f1419; }
    .user-id { color: #536471; font-size: 0.9rem; }
    .follow-btn {
        background-color: #0f1419; color: #fff; border: none; border-radius: 9999px;
        padding: 6px 16px; font-weight: bold; font-size: 0.85rem; cursor: pointer; text-decoration: none;
        flex-shrink: 0; margin-left: 10px;
    }

    /* æœ¬æ–‡ */
    .post-body { 
        font-size: 1rem; margin-bottom: 12px; 
        white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere;
    }
    /* ãƒªãƒ³ã‚¯ã®è‰² */
    .post-body a { color: #1d9bf0; text-decoration: none; }
    .post-body a:hover { text-decoration: underline; }

    /* Moreãƒœã‚¿ãƒ³ */
    .text-truncated {
        display: -webkit-box; -webkit-line-clamp: 10;
        -webkit-box-orient: vertical; overflow: hidden;
    }
    .read-more-btn {
        background: none; border: none; padding: 0;
        color: #1d9bf0; cursor: pointer; font-size: 0.9rem;
        margin-bottom: 10px; display: none;
    }
    .read-more-btn:hover { text-decoration: underline; }

    /* --- ãƒ¡ãƒ‡ã‚£ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
    
    /* ç”»åƒ */
    .post-images { display: grid; gap: 2px; border-radius: 12px; overflow: hidden; margin-top: 12px; border: 1px solid #cfd9de; }
    .post-images img { width: 100%; height: auto; object-fit: cover; display: block; }
    .post-images[data-count="1"] { grid-template-columns: 1fr; }
    .post-images[data-count="2"] { grid-template-columns: 1fr 1fr; }

    /* ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ (Link Card) */
    .link-card {
        display: block; text-decoration: none; color: inherit;
        border: 1px solid #cfd9de; border-radius: 12px; overflow: hidden;
        margin-top: 12px; transition: background 0.2s; position: relative;
    }
    .link-card:hover { background-color: #f7f9f9; }
    .link-card-img { width: 100%; height: 200px; object-fit: cover; display: block; border-bottom: 1px solid #cfd9de; background: #eee; }
    .link-card-content { padding: 12px; }
    .link-card-title { font-weight: bold; font-size: 1rem; margin-bottom: 4px; line-height: 1.4; }
    .link-card-desc { font-size: 0.9rem; color: #536471; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .link-card-host { font-size: 0.85rem; color: #888; }
    
    /* å¼•ç”¨ã‚«ãƒ¼ãƒ‰ */
    .quote-card {
        border: 1px solid #cfd9de; border-radius: 12px; padding: 12px;
        margin-top: 12px; background: #fff; cursor: pointer; transition: background 0.2s;
    }
    .quote-card:hover { background-color: #f7f9f9; }
    .quote-user { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; font-weight: bold; }
    .quote-user img { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }

    /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
    #loading-indicator { text-align: center; padding: 20px; color: #666; display: none; }
    .load-more-btn {
        display: block; width: 100%; padding: 15px; margin-top: 30px; margin-bottom: 60px;
        background: #1d9bf0; color: white; border: none; border-radius: 30px;
        font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center;
    }
    .load-more-btn:hover { background: #1a8cd8; }
</style>
</head>
<body>

<div class="container">
    <div id="feed-container"></div>
    <div id="loading-indicator">èª­ã¿è¾¼ã¿ä¸­...</div>
    <button id="load-more-btn" class="load-more-btn" style="display:none;">éå»ã®æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã‚€</button>
</div>

<script>
    const ACTOR = "katsuobushi-kawa.bsky.social";
    const LIMIT = 30; 
    let currentCursor = null; 
    let isFetching = false;

    document.addEventListener('DOMContentLoaded', () => {
        fetchPosts(); 
        document.getElementById('load-more-btn').addEventListener('click', () => {
            if (!isFetching && currentCursor) fetchPosts(currentCursor);
        });
    });

    async function fetchPosts(cursor = null) {
        if (isFetching) return;
        isFetching = true;

        const loadingIndicator = document.getElementById('loading-indicator');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const container = document.getElementById('feed-container');

        loadingIndicator.style.display = 'block';
        loadMoreBtn.style.display = 'none';

        let url = `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${ACTOR}&filter=posts_with_replies&limit=${LIMIT}`;
        if (cursor) url += `&cursor=${cursor}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("APIã‚¨ãƒ©ãƒ¼");
            const data = await response.json();

            data.feed.forEach(item => {
                const post = item.post;
                const reply = item.reply;
                const article = document.createElement('article');
                article.className = 'card';
                
                const safeId = "post-" + post.uri.split('/').pop(); 
                article.id = safeId;

                // 1. è¦ªæŠ•ç¨¿ï¼ˆè‡ªåˆ†ã¸ã®è¿”ä¿¡ï¼‰
                let parentHtml = '';
                if (reply && reply.parent && reply.parent.author.did === post.author.did) {
                    const parentId = "post-" + reply.parent.uri.split('/').pop();
                    const parentText = reply.parent.record.text || "ãƒ¡ãƒ‡ã‚£ã‚¢æŠ•ç¨¿";
                    parentHtml = `
                        <a href="#${parentId}" class="parent-post-preview" onclick="handleJump(event, '${parentId}', '${reply.parent.uri}')">
                            ${escapeHtml(parentText).substring(0, 60)}...
                        </a>
                    `;
                }

                // 2. â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: Facetsï¼ˆè£ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’ä½¿ã£ãŸæ­£ã—ã„ãƒªãƒ³ã‚¯ç”Ÿæˆâ˜…
                // è¡¨ç¤ºä¸Šã®æ–‡å­—ãŒçœç•¥ã•ã‚Œã¦ã„ã¦ã‚‚ã€ã“ã“ã‹ã‚‰æ­£ã—ã„URLã‚’å–å¾—ã—ã¾ã™
                const bodyText = applyFacets(post.record.text, post.record.facets);
                
                let bodyHtml = `<div class="post-body">${bodyText}</div>`;
                let moreBtnHtml = '';
                
                if (post.record.text.length > 500) {
                    bodyHtml = `<div class="post-body text-truncated" id="body-${safeId}">${bodyText}</div>`;
                    moreBtnHtml = `<button class="read-more-btn" onclick="expandText('body-${safeId}', this)">...ã‚‚ã£ã¨è¦‹ã‚‹</button>`;
                }

                // 3. ãƒ¡ãƒ‡ã‚£ã‚¢è¡¨ç¤ºï¼ˆç”»åƒãƒ»ã‚«ãƒ¼ãƒ‰ï¼‰
                let mediaHtml = renderEmbed(post.embed);

                // 4. â˜…è¿½åŠ ãƒã‚¤ãƒ³ãƒˆ: ç”»åƒã¨URLã®å…±å­˜å¯¾å¿œâ˜…
                // ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¦ãŠã‚Š(mediaHtmlã«ç”»åƒãŒã‚ã‚‹)ã€ã‹ã¤ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆ
                // Facetsã®ä¸­ã«URLãŒã‚ã‚Œã°ã€ãã‚Œã‚’ã‚«ãƒ¼ãƒ‰åŒ–ã—ã¦ã‚ã’ã‚‹å‡¦ç†
                if (post.embed && post.embed.$type.includes('images') && post.record.facets) {
                    const extraCard = createExtraLinkCard(post.record.facets);
                    if (extraCard) {
                        mediaHtml += extraCard;
                    }
                }

                article.innerHTML = `
                    ${parentHtml}
                    <div class="post-header">
                        <img src="${post.author.avatar || 'https://via.placeholder.com/50'}" alt="Icon" class="user-avatar">
                        <div class="user-info">
                            <span class="user-name">${escapeHtml(post.author.displayName || post.author.handle)}</span>
                            <span class="user-id">@${post.author.handle}</span>
                        </div>
                        <a href="https://bsky.app/profile/${post.author.handle}" target="_blank" class="follow-btn">Bluesky</a>
                    </div>
                    ${bodyHtml}
                    ${moreBtnHtml}
                    ${mediaHtml}
                    <div style="font-size:0.85rem; color:#888; margin-top:8px;">
                        ${new Date(post.record.createdAt).toLocaleString()}
                    </div>
                `;
                container.appendChild(article);
                
                if(moreBtnHtml) {
                    article.querySelector('.read-more-btn').style.display = 'inline-block';
                }
            });

            if (data.cursor) {
                currentCursor = data.cursor;
                loadMoreBtn.style.display = 'block';
            } else {
                currentCursor = null;
            }

        } catch (error) {
            console.error(error);
            container.insertAdjacentHTML('beforeend', `<p style="color:red; text-align:center;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`);
        } finally {
            isFetching = false;
            loadingIndicator.style.display = 'none';
        }
    }

    // --- æ©Ÿèƒ½é–¢æ•° ---

    // â˜…Facetsï¼ˆä½ç½®æƒ…å ±ä»˜ããƒªãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’é©ç”¨ã—ã¦HTMLã‚’ä½œã‚‹é–¢æ•°â˜…
    // ã“ã‚Œã«ã‚ˆã‚Š "www.youtube.com..." ã¨ã„ã†æ–‡å­—ã®ä¸‹ã« "https://www.youtube.com/watch?v=..." ã¨ã„ã†æ­£ã—ã„ãƒªãƒ³ã‚¯ã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™
    function applyFacets(text, facets) {
        if (!text) return "";
        if (!facets || facets.length === 0) return escapeHtml(text).replace(/\n/g, '<br>');

        // Blueskyã®indexã¯ã€Œãƒã‚¤ãƒˆæ•°ã€ãªã®ã§ã€JSã®æ–‡å­—åˆ—indexã¨ã‚ºãƒ¬ã¾ã™ã€‚TextEncoderã§è£œæ­£ã—ã¾ã™ã€‚
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();
        const bytes = encoder.encode(text);
        
        let html = '';
        let lastIndex = 0;

        // Facetsã‚’å¿µã®ãŸã‚é–‹å§‹ä½ç½®é †ã«ã‚½ãƒ¼ãƒˆ
        facets.sort((a, b) => a.index.byteStart - b.index.byteStart);

        for (const facet of facets) {
            const start = facet.index.byteStart;
            const end = facet.index.byteEnd;

            // ãƒªãƒ³ã‚¯å‰ã®ãƒ†ã‚­ã‚¹ãƒˆ
            if (start > lastIndex) {
                html += escapeHtml(decoder.decode(bytes.slice(lastIndex, start)));
            }

            // ãƒªãƒ³ã‚¯éƒ¨åˆ†ã®ãƒ†ã‚­ã‚¹ãƒˆã¨URL
            const linkText = decoder.decode(bytes.slice(start, end));
            
            // ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã‚’æ¢ã™
            const linkFeature = facet.features.find(f => f.$type === 'app.bsky.richtext.facet#link');
            
            if (linkFeature) {
                html += `<a href="${linkFeature.uri}" target="_blank" rel="noopener">${escapeHtml(linkText)}</a>`;
            } else {
                // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚„ã‚¿ã‚°ãªã©ã€ä»Šå›ã¯å˜ç´”ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰æ‹¡å¼µå¯èƒ½ï¼‰
                html += escapeHtml(linkText);
            }

            lastIndex = end;
        }

        // æ®‹ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆ
        if (lastIndex < bytes.length) {
            html += escapeHtml(decoder.decode(bytes.slice(lastIndex)));
        }

        return html.replace(/\n/g, '<br>');
    }

    // ç”»åƒã¨å…±å­˜ã™ã‚‹éš ã‚Œãƒªãƒ³ã‚¯ã®ã‚«ãƒ¼ãƒ‰åŒ–ï¼ˆä¸»ã«YouTubeç”¨ï¼‰
    function createExtraLinkCard(facets) {
        let html = '';
        for (const facet of facets) {
            const feat = facet.features.find(f => f.$type === 'app.bsky.richtext.facet#link');
            if (feat) {
                const url = feat.uri;
                // YouTubeã®åˆ¤å®š
                const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);
                if (ytMatch) {
                    const vid = ytMatch[1];
                    const thumb = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
                    html += `
                        <a href="${url}" target="_blank" rel="noopener" class="link-card" style="margin-top:8px;">
                            <img src="${thumb}" class="link-card-img" style="height:180px;">
                            <div class="link-card-content">
                                <div class="link-card-title">YouTubeå‹•ç”»</div>
                                <div class="link-card-host">youtube.com</div>
                            </div>
                        </a>
                    `;
                } else {
                    // YouTubeä»¥å¤–ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã©ã¯å–å¾—ã§ããªã„ã®ã§ç°¡æ˜“è¡¨ç¤ºï¼‰
                    // é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã€ãƒ†ã‚­ã‚¹ãƒˆãƒªãƒ³ã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
                    html += `
                        <a href="${url}" target="_blank" rel="noopener" class="link-card" style="margin-top:8px; display:flex; align-items:center; min-height:auto;">
                            <div class="link-card-content">
                                <div class="link-card-title" style="font-size:0.9rem; margin:0;">ğŸ”— å¤–éƒ¨ãƒªãƒ³ã‚¯: ${new URL(url).hostname}</div>
                                <div class="link-card-desc" style="font-size:0.8rem; color:#888;">${url}</div>
                            </div>
                        </a>
                    `;
                }
            }
        }
        return html;
    }

    function expandText(elementId, btn) {
        document.getElementById(elementId).classList.remove('text-truncated');
        btn.style.display = 'none';
    }

    function renderEmbed(embed) {
        if (!embed) return "";

        // ç”»åƒ
        if (embed.images) {
            let count = embed.images.length;
            let html = `<div class="post-images" data-count="${count}">`;
            embed.images.forEach(img => {
                html += `<img src="${img.thumb}" alt="${escapeHtml(img.alt || '')}">`;
            });
            html += `</div>`;
            return html;
        }
        // å¤–éƒ¨ãƒªãƒ³ã‚¯ (æœ¬æ¥ã®ã‚«ãƒ¼ãƒ‰)
        if (embed.external) {
            const ext = embed.external;
            return `
                <a href="${ext.uri}" target="_blank" rel="noopener" class="link-card">
                    ${ext.thumb ? `<img src="${ext.thumb}" class="link-card-img">` : ''}
                    <div class="link-card-content">
                        <div class="link-card-title">${escapeHtml(ext.title || 'No Title')}</div>
                        <div class="link-card-desc">${escapeHtml(ext.description || '')}</div>
                        <div class="link-card-host">${new URL(ext.uri).hostname}</div>
                    </div>
                </a>
            `;
        }
        // å¼•ç”¨
        if (embed.record && embed.record.value) { 
             const rec = embed.record.value;
             const author = embed.record.author || { handle: 'unknown', avatar: '' };
             const postUri = embed.record.uri || "";
             const postId = postUri.split('/').pop();
             const quoteUrl = `https://bsky.app/profile/${author.handle}/post/${postId}`;
             return `
                <div class="quote-card" onclick="window.open('${quoteUrl}', '_blank')">
                    <div class="quote-user">
                        <img src="${author.avatar || 'https://via.placeholder.com/20'}" alt="">
                        <span>${escapeHtml(author.displayName || author.handle)}</span>
                    </div>
                    <div class="quote-body">${escapeHtml(rec.text || '')}</div>
                </div>
             `;
        }
        // è¤‡åˆ (EmbedWithMedia)
        if (embed.$type === 'app.bsky.embed.recordWithMedia') {
            return renderEmbed(embed.media) + renderEmbed(embed.record);
        }
        return "";
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]);
    }

    function handleJump(e, targetId, bskyUri) {
        e.preventDefault();
        const targetEl = document.getElementById(targetId);
        if (targetEl) {
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetEl.classList.add('highlight');
            setTimeout(() => targetEl.classList.remove('highlight'), 1500);
        } else {
            const parts = bskyUri.split('/');
            const postId = parts.pop();
            window.open(`https://bsky.app/profile/${ACTOR}/post/${postId}`, '_blank');
        }
    }
</script>

</body>
</html>
